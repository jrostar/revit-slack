<?xml version="1.0" encoding="UTF-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="BuildAll">
  <!--
    REQUIRED:
    - install https://github.com/loresoft/msbuildtasks/releases
    SETUP:
    - change project name below
    USE:
    - msbuild build-releases.xml
  -->

  <PropertyGroup>
    <!-- CHANGE PROJECT NAME -->
    <ProjectName>KTM.RevitSlack</ProjectName>
    <!-- END SETUP -->
    <BasePath>$(MSBuildProjectDirectory)</BasePath>
    <FullProjectName>$(BasePath)\$(ProjectName).csproj</FullProjectName>
    <ProjectPublishLocation>$(BasePath)\deploy\</ProjectPublishLocation>
  </PropertyGroup>
  <ItemGroup>
    <ProjectToBuild Include="$(FullProjectName)">
      <Properties>Configuration=Release-2014</Properties>
    </ProjectToBuild>
    <ProjectToBuild Include="$(FullProjectName)">
      <Properties>Configuration=Release-2015</Properties>
    </ProjectToBuild>
    <ProjectToBuild Include="$(FullProjectName)">
      <Properties>Configuration=Release-2016;</Properties>
    </ProjectToBuild>
  </ItemGroup>
  <!-- clean, compile and package! -->
  <Target Name="BuildAll" DependsOnTargets="Clean;Compile;Zip" />
  <!-- get version from one of the assemplies -->


  <Target Name="Clean">
    <RemoveDir Directories="$(ProjectPublishLocation)" />
  </Target>

  <Target Name="Compile">
    <MSBuild Projects="@(ProjectToBuild)" Targets="Rebuild" BuildInParallel="true" />
  </Target>

 <!-- ###
Custom Tasks and Build Events
### -->
  <UsingTask TaskName="ReplaceFileText" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <InputFilename ParameterType="System.String" Required="true" />
      <OutputFilename ParameterType="System.String" Required="true" />
      <MatchExpression ParameterType="System.String" Required="true" />
      <ReplacementText ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Core" />
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Text.RegularExpressions" />
      <Code Type="Fragment" Language="cs"><![CDATA[
              File.WriteAllText(
                  OutputFilename,
                  Regex.Replace(File.ReadAllText(InputFilename), MatchExpression, ReplacementText)
                  );
            ]]></Code>
    </Task>
  </UsingTask>
<!-- https://github.com/loresoft/msbuildtasks -->
<ItemGroup>
  <AllFiles Include="$(ProjectPublishLocation)\**\*"/>
  <OnlyDirs Include="@(AllFiles->'%(ProjectPublishLocation)')"/>
</ItemGroup>
<Import Project="$(MSBuildExtensionsPath32)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
<Target Name="Zip">
   <Message Text="Zipping..." />
   <CreateItem Include="$(ProjectPublishLocation)\**\*" >
               <Output ItemName="ZipFiles" TaskParameter="Include"/>
       </CreateItem>
       <Zip ZipFileName="$(ProjectName).zip" WorkingDirectory="$(ProjectPublishLocation)" Files="@(ZipFiles)" />
 </Target>
</Project>